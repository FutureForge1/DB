## 第1步：创建表 (CREATE TABLE)

```
-- 创建作者表 (authors)
CREATE TABLE authors (
    author_id INT PRIMARY KEY, -- 作者ID, 主键
    author_name VARCHAR(100) NOT NULL UNIQUE  -- 作者姓名, 不能为空, 且唯一
);

-- 创建图书表 (books)
CREATE TABLE books (
    book_id INT PRIMARY KEY,   -- 图书ID, 主键, 自增长
    title VARCHAR(255) NOT NULL,              -- 书名, 不能为空
    genre VARCHAR(50),                        -- 类型
    pages INT,                                -- 页数
    author_id INT                          -- 作者ID
);

```

## 第2步：插入数据 (INSERT)

```
-- 首先, 向 authors 表插入数据
INSERT INTO authors (author_name) VALUES
('刘慈欣'),     -- author_id 将是 1
('金庸'),       -- author_id 将是 2
('J.K. 罗琳'),  -- author_id 将是 3
('村上春树'),   -- author_id 将是 4
('余华');       -- author_id 将是 5

-- 然后, 向 books 表插入数据
INSERT INTO books (title, genre, pages, author_id) VALUES
('三体I', '科幻', 302, 1),
('三体II：黑暗森林', '科幻', 478, 1),
('球状闪电', '科幻', 350, 1),
('射雕英雄传', '武侠', 1227, 2),
('天龙八部', '武侠', 2054, 2),
('哈利·波特与魔法石', '奇幻', 257, 3),
('挪威的森林', '小说', 387, 4),
('活着', '小说', 198, 5);
```

### 第3步：测试查询语句 (SELECT)

#### 3.1 基础查询

```
-- 1. 查询所有图书的所有信息
SELECT * FROM books;

-- 2. 查询所有作者的姓名
SELECT author_name FROM authors;

-- 3. 查询所有图书的书名和类型
SELECT title, genre FROM books;
```

#### 3.2 条件查询 (WHERE)

```
-- 1. 查询所有类型为 '科幻' 的图书
SELECT * FROM books WHERE genre = '科幻';

-- 2. 查询页数超过 500 页的图书
SELECT title, pages FROM books WHERE pages > 500;

-- 3. 查询作者ID为 2 (金庸) 的所有著作
SELECT * FROM books WHERE author_id = 2;

-- 4. 查询类型为 '武侠' 且页数超过 1500 页的图书 (AND)
SELECT * FROM books WHERE genre = '武侠' AND pages > 1500;

-- 5. 查询类型为 '小说' 或 '奇幻' 的图书 (OR / IN)
-- 使用 OR
SELECT * FROM books WHERE genre = '小说' OR genre = '奇幻';

```

#### 3.3 排序查询 (ORDER BY)

```
-- 1. 按页数从多到少查询所有图书
-- DESC 表示降序, ASC 表示升序 (默认)
SELECT title, pages FROM books ORDER BY pages DESC;

-- 2. 按作者姓名进行字母/拼音排序
SELECT * FROM authors ORDER BY author_name ASC;
```

#### 3.4 聚合函数

```
-- 1. 统计图书馆里总共有多少本书
SELECT COUNT(*) AS total_books FROM books;

-- 2. 计算所有书的平均页数
SELECT AVG(pages) AS average_pages FROM books;

-- 3. 找出页数最多的一本书有多少页
SELECT MAX(pages) AS max_pages FROM books;

-- 4. 找出 '科幻' 类图书的总页数
SELECT SUM(pages) AS total_sci_fi_pages FROM books WHERE genre = '科幻';
```

#### 3.5 分组查询 (GROUP BY 和 HAVING)

```
-- 1. 统计每位作者分别写了多少本书 (需要连接查询，见下一节)
-- 我们先按作者ID统计
SELECT author_id, COUNT(*) AS book_count FROM books GROUP BY author_id;

-- 2. 计算每种类型的图书的平均页数
SELECT genre, AVG(pages) AS avg_pages_per_genre FROM books GROUP BY genre;

-- 3. 查询拥有超过 1 本书的作者ID
-- HAVING 用于对分组后的结果进行过滤
SELECT author_id, COUNT(*) AS book_count FROM books GROUP BY author_id HAVING COUNT(*) > 1;


```

#### 3.6 连接查询 (JOIN)

```
-- 1. 查询所有图书的名称及其作者的姓名 (INNER JOIN)
-- 这是最常见的用法，将图书和作者信息关联起来
SELECT
    b.title,
    a.author_name
FROM
    books AS b
INNER JOIN
    authors AS a ON b.author_id = a.author_id;

-- 2. 列出所有作者以及他们写的书，即使某个作者没有书在库里也要列出来 (LEFT JOIN)
-- 为了测试这个，我们先加一个没有作品的作者
INSERT INTO authors (author_name) VALUES ('鲁迅');

-- 现在执行 LEFT JOIN
SELECT
    a.author_name,
    b.title
FROM
    authors AS a
LEFT JOIN
    books AS b ON a.author_id = b.author_id;
-- 你会看到，鲁迅出现在结果中，但对应的 title 是 NULL
```

### 第4步：测试数据修改语句

#### 4.1 更新数据 (UPDATE)

```
-- 1. 发现《挪威的森林》类型写错了，更新为 '当代小说'
UPDATE books SET genre = '当代小说' WHERE title = '挪威的森林';

-- 查询确认修改结果
SELECT * FROM books WHERE book_id = 7;
```

#### 4.2 删除数据 (DELETE)

```
-- 1. 假设《球状闪电》这本书丢失了，从数据库中删除
DELETE FROM books
WHERE title = '球状闪电';

-- 查询确认，这本书已经不存在了
SELECT * FROM books;
```

## 第5步：测试修改表结构 (ALTER TABLE)

```
-- 1. 给图书表增加一个 '出版社' (publisher) 列
ALTER TABLE books
ADD COLUMN publisher VARCHAR(100);

-- 查看表结构确认（或直接查询）
SELECT * FROM books;

-- 2. 删除刚刚添加的列
ALTER TABLE books
DROP COLUMN publisher;
```

### 第6步：删除表 (DROP TABLE)

```
-- 因为 books 表依赖 authors 表 (外键)，所以要先删除 books
DROP TABLE books;

-- 然后再删除 authors
DROP TABLE authors;
```

## 第7步：索引相关

**1. 查看 `authors` 表的索引**

```
SHOW INDEX FROM authors;
```

**2. 查看 `books` 表的索引**

```
SHOW INDEX FROM books;
```

------

### 创建新的“显式”索引

**1. 为场景A创建单列索引**

```
CREATE INDEX idx_books_genre ON books (genre);
```

**2. 为场景B创建复合索引**

```
CREATE INDEX idx_books_author_pages ON books (author_id, pages);
```

------

### 验证新创建的索引

```
SHOW INDEX FROM books;
```

------

### 删除索引

**1. 删除复合索引**

```
DROP INDEX idx_books_author_pages ON books;
```

```
DROP INDEX idx_books_genre ON books;
```

### 最后验证

```
SHOW INDEX FROM books;
```

## 错误验证：

```
SELECT * FROM books WHERE invalid_column = 'test';
SELECT * FROM non_existent_table;
CREATE TABLE books (id INT);
DROP TABLE non_existent_table;
```

## 事务

```
CREATE TABLE demo_users (id INTEGER PRIMARY KEY, name VARCHAR(50), age INTEGER);
BEGIN;
INSERT INTO demo_users (id, name, age) VALUES (1, 'Alice', 25);
INSERT INTO demo_users (id, name, age) VALUES (2, 'Bob', 30);
COMMIT;
SELECT * FROM demo_users;
BEGIN;
UPDATE demo_users SET age = 26 WHERE name = 'Alice';
ROLLBACK;
```

